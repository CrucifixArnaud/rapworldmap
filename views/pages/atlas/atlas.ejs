<!-- MapBox -->
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js'></script>

<div id='map' class='mapbox'></div>

<script>
L.mapbox.accessToken = 'pk.eyJ1IjoiY3J1Y2lmaXhhcm5hdWQiLCJhIjoiY2lxejJocHB6MDA1dWkybWc1MnhyMWRoOCJ9.BcDRx2fZ0sl3q5ofSTbZ_g';

var map = L.mapbox.map('map')
    .setView([36.3843749, -98.7628543], 5)
    .addLayer(L.mapbox.tileLayer('mapbox.dark'));

L.mapbox.featureLayer().loadURL('/artists/geojson').on('ready', function(e) {
  // The clusterGroup gets each marker in the group added to it
  // once loaded, and then is added to the map
  var clusterGroup = new L.MarkerClusterGroup();
  e.target.eachLayer(function(layer) {

    var marker = layer,
      feature = marker.feature;

    var popupContent =  '<div id="' + feature.properties.id + '" class="popup">' +
      '<h2 class="popup__title artist__name">' + feature.properties.name + '</h2>' +
      '<div class="popup__thumbnail">' +
        '<img src="' + feature.properties.icon.iconUrl + '" class="image" alt="">' +
      '<div>' +
      '<div class="popup__body">' +
        '<div class="artist__location">' +
          '<h2 class="popup__body__title">Location:</h2>' +
          '<p class="artist__location__city">' + feature.properties.location.city +'</p>' +
          '<p class="artist__location__neighborhood">' + feature.properties.location.neighborhood +'</p>' +
        '</div>' +
        '<div class="artist__bio">' +
          '<h2 class="popup__body__title">Bio:</h2>' +
          '<p class="artist__bio__summary">' + feature.properties.bio.summary +'</p>' +
          '<a class="artist__bio__wikipedia href="' + feature.properties.bio.wikipediaUrl +'" title="Open the youtube page of ' + feature.properties.name + '">Wikipedia Page</a>' +
          '<p class="artist__bio__birthdate">Borndate: ' + feature.properties.bio.birthdate +'</p>' +
          '<p class="artist__bio__deathdate">Deathdate:' + feature.properties.bio.deathdate +'</p>' +
        '</div>' +
        '<div class="artist__youtube">' +
          '<h2 class="popup__body__title">Youtube:</h2>' +
          '<iframe width="300" height="169" src="' + feature.properties.youtube.clipExampleUrl + '" frameborder="0" allowfullscreen></iframe>' +
          '<a class="artist__youtube__page-url" href="' + feature.properties.youtube.pageUrl +'" title="Open the youtube page of ' + feature.properties.name + '">Youtube Page</a>' +
        '</div>' +
      '</div>' +
    '</div>';

    marker.bindPopup(popupContent);

    marker.setIcon(L.icon(feature.properties.icon));

    var content = '<h2>'+ feature.properties.name+'<\/h2>' + '<img src="'+feature.properties.icon.iconUrl+'" alt="">';

    clusterGroup.addLayer(layer);
  });
  map.addLayer(clusterGroup);
});

</script>